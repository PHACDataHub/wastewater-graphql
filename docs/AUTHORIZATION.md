
# Data Authorization

> Notice: This file is automatically generated by
> [generate_auth_docs.ts](../graphql/generate_auth_docs.ts).

Below you will find various diagrams that illustrates how to API restricts
access to data.

## How it works

This project is hosted behind an Azure API gateway that determines what data
can be returned by a given client via [subscriptions](https://learn.microsoft.com/en-us/azure/api-management/api-management-subscriptions).  Each subscription is tied to a
*product* which modifies the `x-auth-group` header sent to this service.  The
available values and filters are defined in the [auth.ts](../graphql/auth.ts)
file.

```javascript
// auth.ts
{
  "nml-lab": {},
  "csc": {
    "sites": {
      "where": [
        "healthReg",
        "CSC"
      ]
    }
  },
  "bccdc": {
    "datasets": {
      "where": [
        "dataID",
        "BCCDC"
      ]
    }
  },
  "hnj": {
    "sites": {
      "where": [
        "siteID",
        "HNJ"
      ]
    },
    "datasets": {
      "whereIn": [
        "dataID",
        [
          "NML-WWPCR",
          "NML-WWGX"
        ]
      ]
    }
  }
}
```

### Authorization flow

The process described above is illustrated below using a flow chart.

![Authorization flow chart](auth.flowchart.svg)

## SQL Query modifications

When the GraphQL server receives a request to access data in a particular table,
the foreign key relationships of the table are examined, and a query plan is
produced that enforces the rules declared in [auth.ts](../graphql/auth.ts).

The diagrams below illustrates what the resulting query plan is for each group
and table combination.


### nml-lab -> addresses

![nml-lab addresses query flow](nml-lab/addresses.dot.svg)


### nml-lab -> organizations

![nml-lab organizations query flow](nml-lab/organizations.dot.svg)


### nml-lab -> datasets

![nml-lab datasets query flow](nml-lab/datasets.dot.svg)


### nml-lab -> polygons

![nml-lab polygons query flow](nml-lab/polygons.dot.svg)


### nml-lab -> instruments

![nml-lab instruments query flow](nml-lab/instruments.dot.svg)


### nml-lab -> optionSets

![nml-lab optionSets query flow](nml-lab/optionSets.dot.svg)


### nml-lab -> setLUs

![nml-lab setLUs query flow](nml-lab/setLUs.dot.svg)


### nml-lab -> partLUs

![nml-lab partLUs query flow](nml-lab/partLUs.dot.svg)


### nml-lab -> contacts

![nml-lab contacts query flow](nml-lab/contacts.dot.svg)


### nml-lab -> measureSets

![nml-lab measureSets query flow](nml-lab/measureSets.dot.svg)


### nml-lab -> methodSteps

![nml-lab methodSteps query flow](nml-lab/methodSteps.dot.svg)


### nml-lab -> methodSets

![nml-lab methodSets query flow](nml-lab/methodSets.dot.svg)


### nml-lab -> languageLUs

![nml-lab languageLUs query flow](nml-lab/languageLUs.dot.svg)


### nml-lab -> translationLUs

![nml-lab translationLUs query flow](nml-lab/translationLUs.dot.svg)


### nml-lab -> sites

![nml-lab sites query flow](nml-lab/sites.dot.svg)


### nml-lab -> samples

![nml-lab samples query flow](nml-lab/samples.dot.svg)


### nml-lab -> measures

![nml-lab measures query flow](nml-lab/measures.dot.svg)


### csc -> addresses

![csc addresses query flow](csc/addresses.dot.svg)


### csc -> organizations

![csc organizations query flow](csc/organizations.dot.svg)


### csc -> datasets

![csc datasets query flow](csc/datasets.dot.svg)


### csc -> polygons

![csc polygons query flow](csc/polygons.dot.svg)


### csc -> instruments

![csc instruments query flow](csc/instruments.dot.svg)


### csc -> optionSets

![csc optionSets query flow](csc/optionSets.dot.svg)


### csc -> setLUs

![csc setLUs query flow](csc/setLUs.dot.svg)


### csc -> partLUs

![csc partLUs query flow](csc/partLUs.dot.svg)


### csc -> contacts

![csc contacts query flow](csc/contacts.dot.svg)


### csc -> measureSets

![csc measureSets query flow](csc/measureSets.dot.svg)


### csc -> methodSteps

![csc methodSteps query flow](csc/methodSteps.dot.svg)


### csc -> methodSets

![csc methodSets query flow](csc/methodSets.dot.svg)


### csc -> languageLUs

![csc languageLUs query flow](csc/languageLUs.dot.svg)


### csc -> translationLUs

![csc translationLUs query flow](csc/translationLUs.dot.svg)


### csc -> sites

![csc sites query flow](csc/sites.dot.svg)


### csc -> samples

![csc samples query flow](csc/samples.dot.svg)


### csc -> measures

![csc measures query flow](csc/measures.dot.svg)


### bccdc -> addresses

![bccdc addresses query flow](bccdc/addresses.dot.svg)


### bccdc -> organizations

![bccdc organizations query flow](bccdc/organizations.dot.svg)


### bccdc -> datasets

![bccdc datasets query flow](bccdc/datasets.dot.svg)


### bccdc -> polygons

![bccdc polygons query flow](bccdc/polygons.dot.svg)


### bccdc -> instruments

![bccdc instruments query flow](bccdc/instruments.dot.svg)


### bccdc -> optionSets

![bccdc optionSets query flow](bccdc/optionSets.dot.svg)


### bccdc -> setLUs

![bccdc setLUs query flow](bccdc/setLUs.dot.svg)


### bccdc -> partLUs

![bccdc partLUs query flow](bccdc/partLUs.dot.svg)


### bccdc -> contacts

![bccdc contacts query flow](bccdc/contacts.dot.svg)


### bccdc -> measureSets

![bccdc measureSets query flow](bccdc/measureSets.dot.svg)


### bccdc -> methodSteps

![bccdc methodSteps query flow](bccdc/methodSteps.dot.svg)


### bccdc -> methodSets

![bccdc methodSets query flow](bccdc/methodSets.dot.svg)


### bccdc -> languageLUs

![bccdc languageLUs query flow](bccdc/languageLUs.dot.svg)


### bccdc -> translationLUs

![bccdc translationLUs query flow](bccdc/translationLUs.dot.svg)


### bccdc -> sites

![bccdc sites query flow](bccdc/sites.dot.svg)


### bccdc -> samples

![bccdc samples query flow](bccdc/samples.dot.svg)


### bccdc -> measures

![bccdc measures query flow](bccdc/measures.dot.svg)


### hnj -> addresses

![hnj addresses query flow](hnj/addresses.dot.svg)


### hnj -> organizations

![hnj organizations query flow](hnj/organizations.dot.svg)


### hnj -> datasets

![hnj datasets query flow](hnj/datasets.dot.svg)


### hnj -> polygons

![hnj polygons query flow](hnj/polygons.dot.svg)


### hnj -> instruments

![hnj instruments query flow](hnj/instruments.dot.svg)


### hnj -> optionSets

![hnj optionSets query flow](hnj/optionSets.dot.svg)


### hnj -> setLUs

![hnj setLUs query flow](hnj/setLUs.dot.svg)


### hnj -> partLUs

![hnj partLUs query flow](hnj/partLUs.dot.svg)


### hnj -> contacts

![hnj contacts query flow](hnj/contacts.dot.svg)


### hnj -> measureSets

![hnj measureSets query flow](hnj/measureSets.dot.svg)


### hnj -> methodSteps

![hnj methodSteps query flow](hnj/methodSteps.dot.svg)


### hnj -> methodSets

![hnj methodSets query flow](hnj/methodSets.dot.svg)


### hnj -> languageLUs

![hnj languageLUs query flow](hnj/languageLUs.dot.svg)


### hnj -> translationLUs

![hnj translationLUs query flow](hnj/translationLUs.dot.svg)


### hnj -> sites

![hnj sites query flow](hnj/sites.dot.svg)


### hnj -> samples

![hnj samples query flow](hnj/samples.dot.svg)


### hnj -> measures

![hnj measures query flow](hnj/measures.dot.svg)

